<!DOCTYPE html>
{% load static %}
<html>
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/dashboard.css' %}">
    <script src="{% static 'js/index.js' %}"></script>
    <script src="{% static 'js/popups.js' %}"></script>
    <script src="{% static 'js/analisis.js' %}"></script>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.1/dist/tesseract.min.js"></script>
    <link href="{% static 'favicon.png' %}" rel="shortcut icon" type="image/x-icon"/>
    <link href="{% static 'favicon.png' %}" rel="apple-touch-icon"/> 
   
</head>

<body class="dashboard">
  <div class="navigation">
    <div class="wrapper2">
        <div class="abilan">
            <img src="{% static 'logo2.png' %}" />
        </div>
        <div class="folders">
            <div class="folder-icons">
                <a class="icon-name" href="{% url 'dashboard' %}">Inicio</a>
            </div>
            <div class="folder-icons">
                <a class="icon-name" href="{% url 'agregar_paciente' %}">Agregar Paciente</a>
            </div>
        </div>
    </div>
  </div>
  <div class="right-side wrapper">
      <div class="top-bar-justify">
          <h1 class="big-inbox">Bienvenido, {{ user.nombre }} {{ user.apellidos }}</h1> <!-- Display psychologist's name -->
          <a class="compose" href="{% url 'logout' %}">Cerrar Sesión</a>
      </div>
      
      <div class="right-body">
        <div class="scroll-cards">
            
            
            <div class="container">
                <h1>Lista de Pacientes</h1>
                <form id="search-form">
                    <input type="text" id="search-input" name="search" placeholder="Buscar paciente por nombre">
                </form>
                <script>
                    document.getElementById('search-input').addEventListener('input', function() {
                         let searchQuery = this.value;
                         
                         // Enviar solicitud AJAX para buscar pacientes
                         fetch(`{% url 'dashboard' %}?search=${searchQuery}`, {
                             method: 'GET',
                             headers: {
                                 'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                let pacientesContainer = document.getElementById('pacientes-container');
                                pacientesContainer.innerHTML = '';
                                
                                if (data.pacientes.length > 0) {
                                    data.pacientes.forEach(paciente => {
                                        pacientesContainer.innerHTML += `
                                        <div class="scroll-cards">
                                            <div class="card" onclick="toggleDetails(${paciente.id})">
                                                <div class="mails">
                                                    <img src="${paciente.foto || '{% static "logo2.png" %}'}" alt="Foto de ${paciente.nombre_completo}">
                                                    <h2 class="mail-names">${paciente.nombre_completo}</h2>
                                                    <br>
                                                    </div>
                                                    <div class="mail-info">
                                                        <p class="mail-info">Edad: ${paciente.edad} años</p>
                                                        </div>
                                                        </div>
                                                        </div>`;
                                                    });
                                                } else {
                                                    pacientesContainer.innerHTML = '<p>No existen pacientes.</p>';
                                                }
                                            })
                                            .catch(error => console.error('Error al buscar pacientes:', error));
                                        });
                                        </script>
                <div class="mail-info">
                    {% if pacientes %}
                        {% for paciente in pacientes %}
                            <div class="scroll-cards">
                                <div class="card" onclick="toggleDetails( {{ paciente.id }} )">
                                    <div class="mails">
                                        {% if paciente.foto %}
                                            <img src="{{ paciente.foto.url }}" alt="Foto de {{ paciente.nombre_completo }}">
                                        {% else %}
                                            <img src="{% static 'logo2.png' %}" alt="Foto de perfil">
                                        {% endif %}
                                        <h2 class="mail-names">{{ paciente.nombre_completo }}</h2>
                                        <br>
                                    </div>
                                    <div class="mail-info">
                                        <p class="mail-info">Edad: {{ paciente.edad }} años</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>No existen pacientes.</p>
                    {% endif %}
                </div>
            </div>
            
        </div>    
        {% for paciente in pacientes %}
        <div class="message details-container" id="details-{{ paciente.id }}" style="display: none;">
            {% if paciente.foto %}
            <img class="imagen-detalles" src="{{ paciente.foto.url }}" alt="Foto de {{ paciente.nombre_completo }}">
            {% else %}
            <img class="imagen-detalles" src="{% static 'logo2.png' %}" alt="Foto de perfil">
            {% endif %}
            <h2 class="mail-names">{{ paciente.nombre_completo }}</h2>
            <p class="mail-info">Edad: {{ paciente.edad }} años</p>

            <div class="tabs">
                <ul class="tab-links">
                    <li class="active"><a href="#tab1">Información Básica</a></li>
                    <li><a href="#tab2">Información de los Padres</a></li>
                    <li><a href="#tab3">Información de los Hermanos</a></li>
                    <li><a href="#tab4">Otras Personas en el Hogar</a></li>
                    <li><a href="#tab5">Antecedentes Médicos</a></li>
                    <li><a href="#tab6">Análisis de Citas</a></li>
                </ul>
            
                <div class="tab-content">
                    <div id="tab1" class="tab active">
                        <!-- Información Básica -->
                        <p>Género: {{ paciente.genero }}</p>
                        <p>Correo: {{ paciente.correo }}</p>
                        <p>Teléfono: {{ paciente.telefono }}</p>
                        <p>Dirección: {{ paciente.direccion }}</p>
                        <p>Fecha de Registro: {{ paciente.fecha_registro }}</p>
                        <p>Fecha de Nacimiento: {{ paciente.fecha_nacimiento }}</p>
                        <p>Lugar de Nacimiento: {{ paciente.lugar_nacimiento }}</p>
                        <p>Escolaridad: {{ paciente.escolaridad }}</p>
                        <p>Estado Civil: {{ paciente.estado_civil }}</p>
                        <p>Religión: {{ paciente.religion }}</p>
                        <p>Acude Voluntariamente: {{ paciente.acude_voluntariamente|yesno:"Sí,No" }}</p>
                    </div>
            
                    <div id="tab2" class="tab">
                        <!-- Información de los Padres -->
                        {% for padre in paciente.padres.all %}
                            <h3>Información del Padre</h3>
                            <p>Nombre: {{ padre.nombre_padre }}</p>
                            <p>Edad: {{ padre.edad_padre }}</p>
                            <p>Escolaridad: {{ padre.escolaridad_padre }}</p>
                            <p>Ocupación: {{ padre.ocupacion_padre }}</p>
                            <p>Antecedentes Patológicos: {{ padre.antecedentes_patologicos_padre }}</p>
            
                            <h3>Información de la Madre</h3>
                            <p>Nombre: {{ padre.nombre_madre }}</p>
                            <p>Edad: {{ padre.edad_madre }}</p>
                            <p>Escolaridad: {{ padre.escolaridad_madre }}</p>
                            <p>Ocupación: {{ padre.ocupacion_madre }}</p>
                            <p>Antecedentes Patológicos: {{ padre.antecedentes_patologicos_madre }}</p>
            
                            <p>Estado Civil de los Padres: {{ padre.estado_civil_padres }}</p>
                        {% endfor %}
                    </div>
            
                    <div id="tab3" class="tab">
                        <!-- Información de los Hermanos -->
                        {% for hermano in paciente.hermanos.all %}
                            <p>Nombre Hermano: {{ hermano.nombre }}</p>
                            <p>Edad: {{ hermano.edad }}</p>
                            <p>Grado Escolar: {{ hermano.grado_escolar }}</p>
                            <p>Antecedentes Patológicos: {{ hermano.antecedentes_patologicos }}</p>
                            <p>Adicciones: {{ hermano.adicciones }}</p>
                        {% endfor %}
                    </div>
            
                    <div id="tab4" class="tab">
                        <!-- Otras Personas en el Hogar -->
                        {% for hogar in paciente.hogar.all %}
                            <p>{{ hogar.otras_personas }}</p>
                        {% endfor %}
                    </div>
            
                    <div id="tab5" class="tab">
                        <!-- Antecedentes Médicos -->
                        {% for salud in paciente.salud.all %}
                            <p>Asma/Alergias: {{ salud.asma_alergias }}</p>
                            <p>Catarros Frecuentes: {{ salud.catarros_frecuentes }}</p>
                            <p>Epilepsia/Convulsiones: {{ salud.epilepsia_convulsiones }}</p>
                            <p>Convulsiones Febriles: {{ salud.convulsiones_febriles }}</p>
                            <p>Manías: {{ salud.manias }}</p>
                            <p>Lesiones en la Cabeza: {{ salud.lesiones_cabeza }}</p>
                            <p>Cirugías/Hospitalización: {{ salud.cirugias_hospitalizacion }}</p>
                            <p>Problemas de Visión: {{ salud.problemas_vision }}</p>
                            <p>Problemas de Apetito: {{ salud.problemas_apetito }}</p>
                        {% endfor %}
                    </div>

                    <div id="tab6" class="tab">
                        <h3>Listado de Manuscritos</h3>
                    
                        {% if paciente.manuscrito_set.exists %}
                            {% for manuscrito in paciente.manuscrito_set.all %}
                                <div class="manuscrito-item">
                                    <p><strong>Fecha:</strong> {{ manuscrito.fecha }}</p>
                                    <button class="verNotasBtn" data-manuscrito-id="{{ manuscrito.id }}">Ver Notas</button>
                    
                                    <!-- Contenedor de notas que se muestra al hacer clic en "Ver Notas" -->
                                    <div id="notasContainer-{{ manuscrito.id }}" class="notasContainer">
                                        <p><strong>Texto:</strong> {{ manuscrito.texto }}</p>
                                    
                                        {% if manuscrito.imagen %}
                                            <p><strong>Imagen del manuscrito:</strong></p>
                                            <img src="{{ manuscrito.imagen.url }}" alt="Imagen del manuscrito" style="width: 100%; height: auto;">
                                        {% endif %}
                                    
                                        <p><strong>Nube de Palabras:</strong></p>
                                        {% if manuscrito.nube_palabras %}
                                            <img src="{{ manuscrito.nube_palabras.url }}" alt="Nube de Palabras" style="width: 100%; height: auto;">
                                        {% else %}
                                            <p>No se ha generado la nube de palabras aún.</p>
                                        {% endif %}
                                    </div>
                                    
                    
                                    <!-- Formulario para eliminar manuscrito -->
                                    <form method="POST" id="deleteForm-{{ manuscrito.id }}">
                                        {% csrf_token %}
                                        <button type="button" class="btn-delete" onclick="submitDeleteForm({{ manuscrito.id }}, {{ paciente.id }})">Eliminar Manuscrito</button>
                                    </form>
                                    <script>
                                        function submitDeleteForm(manuscritoId, pacienteId) {
                                            var form = document.getElementById('deleteForm-' + manuscritoId);
                                            form.action = '/dashboard/borrar-manuscrito/' + pacienteId + '/' + manuscritoId + '/';
                                            form.submit();
                                        }
                                    </script>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p>No existen manuscritos previos.</p>
                        {% endif %}
                    
                        <!-- Botón de agregar manuscrito siempre visible -->
                        <button id="abrirPopup">Agregar Manuscrito</button>
                    </div>
                    
                    
                    
                    
                    
                    <!-- Popup para agregar una nueva nota -->
                    <div id="agregarNotaPopup" class="popup" style="display: none;">
                        <div class="popup-content">
                            <span class="close" id="cerrarPopup">&times;</span>
                            <form id="formImagen" method="POST" enctype="multipart/form-data" action="{% url 'generar_nube_popup' paciente.id %}">
                                {% csrf_token %}
                                <label for="fecha">Fecha de la Cita:</label>
                                <input type="date" id="fecha" name="fecha" required>
                                <br>
                                <div class="content-container">
                                    <div class="image-container">
                                        <label for="imagen">Cargar Imagen de la Nota:</label>
                                        <input type="file" id="imagen" name="imagen" accept="image/*" required>
                                        <br>
                                        <img id="previewImagen" style="display: none; width: 100%; height: auto;" alt="Previsualización de la imagen">
                                    </div>
                                    <div class="text-container">
                                        <label for="texto">Texto Extraído (Editable):</label>
                                        <textarea id="texto" name="texto" rows="10" cols="30" disabled></textarea>
                                    </div>
                                </div>
                                <br>
                                <!-- Contenedor para la nube de palabras -->
                                <div id="nubePalabrasContainer" style="display: block;">
                                    <label>Nube de Palabras:</label>
                                    <img id="nubePalabrasImagen" src="" alt="Nube de Palabras" style="width: 100%; height: auto;">
                                </div>
                                <br>
                                <div id="loadingIndicator" style="display: none;">Procesando imagen, por favor espera...</div>
                                <br>
                                <button type="submit" id="guardarNotaBtn" disabled>Guardar Nota</button>
                                <button type="button" id="cancelarPopup">Cancelar</button>
                            </form>
                        </div>
                        <script>
                            document.getElementById('texto').addEventListener('input', function() {
                                const form = document.getElementById('formImagen');
                                const formData = new FormData(form);
                                
                                fetch(form.action, {
                                    method: 'POST',
                                    body: formData,
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.nube_url) {
                                        const nubePalabrasContainer = document.getElementById('nubePalabrasContainer');
                                        const nubePalabrasImagen = document.getElementById('nubePalabrasImagen');
                                        nubePalabrasImagen.src = data.nube_url;
                                        nubePalabrasContainer.style.display = 'block';
                                    } else if (data.error) {
                                        console.error('Error:', data.error);
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                            });

                            document.getElementById('formImagen').addEventListener('submit', function(event) {
                                event.preventDefault(); // Evitar el envío normal del formulario
                                
                                    var formData = new FormData(this);
                                    var loadingIndicator = document.getElementById('loadingIndicator');
                                    var guardarNotaBtn = document.getElementById('guardarNotaBtn');
                                    var nubePalabrasContainer = document.getElementById('nubePalabrasContainer');
                                    var nubePalabrasImagen = document.getElementById('nubePalabrasImagen');
                                    var textoArea = document.getElementById('texto');
                                
                                    // Mostrar indicador de carga
                                    loadingIndicator.style.display = 'block';
                                    guardarNotaBtn.disabled = true;
                                
                                    fetch(this.action, {
                                        method: 'POST',
                                        body: formData
                                    }).then(response => response.json())
                                    .then(data => {
                                        if (data.error) {
                                            alert('Error: ' + data.error);
                                        } else {
                                            // Actualizar el texto extraído en el textarea
                                            textoArea.value = data.texto;
                                
                                            // Actualizar la imagen de la nube de palabras
                                            nubePalabrasImagen.src = data.nube_url;
                                            nubePalabrasContainer.style.display = 'block'; // Asegurarse de que se muestre
                                        }
                                    }).catch(error => {
                                        console.error('Error al procesar la imagen:', error);
                                    }).finally(() => {
                                        // Ocultar indicador de carga
                                        loadingIndicator.style.display = 'none';
                                        guardarNotaBtn.disabled = false;
                                    });
                                });

                        </script>
                    </div>



                    
                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            const tabLinks = document.querySelectorAll(".tab-links a");
                            const tabs = document.querySelectorAll(".tab");
                            
                            tabLinks.forEach(function (link) {
                                link.addEventListener("click", function (e) {
                                    e.preventDefault();
                                    
                                    // Quitar clase "active" de todas las pestañas y enlaces
                                    tabLinks.forEach(function (item) {
                                        item.parentElement.classList.remove("active");
                                    });
                                    
                                    tabs.forEach(function (tab) {
                                        tab.classList.remove("active");
                                    });
                                    
                                    // Añadir clase "active" a la pestaña y enlace actual
                                    const currentTab = document.querySelector(this.getAttribute("href"));
                                    currentTab.classList.add("active");
                                    this.parentElement.classList.add("active");
                                });
                            });
                        });

                    </script>
                </div>
            </div>
    
      
        </div>
    {% endfor %}
    
          
          <div id="citas-section" class="profile">
              <h2 class="names">Citas</h2>
              {% if citas %}
                  <ul class="items">
                      {% for cita in citas %}
                          <li class="mail-info">{{ cita.fecha }} - {{ cita.paciente.nombre }} {{ cita.paciente.apellido }}</li>
                      {% endfor %}
                  </ul>
              {% else %}
                  <p class="icon-name">No tienes citas próximas.</p>
              {% endif %}
              
              {% if pacientes %}
              {% else %}
                  <p class="icon-name">No puedes agregar citas hasta que tengas pacientes registrados.</p>
              {% endif %}
          </div>
      </div>
  </div>
</body>
</html>
